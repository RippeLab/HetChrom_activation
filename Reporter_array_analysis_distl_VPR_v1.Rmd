---
title: "Reporter_array_analysis_v1"
output: html_document

---

Preprocessing  with Fiji Macro, Cellpose and ilastik

	1. Convert .ims to .tif and MaxProj with Macro_IMS_to_TIFF_and__makemaxZ_saveTIFF-NMv6.ijm
	2. Split channels of maxproj images with splitchannel_saveim_V2.ijm
	3. Cellpose
		- Range cell diameter for U2OS 
		- Batch processing: ~ 270 diameter  pixels
  4. Merge 637nm (Halo) and 488nm (GFP) channels with Merge_channels_v1_CT.ijm
  5. Import C1C3 .tif images + nuclear masks to ilastik, train with 5 images 

---

Obtain quantitative data for ALL IMAGES

```{r}

library(EBImage)
library(dplyr)
library(stringr)
source('insert file path/quantNuclei_v01_LF.R')

datadir <- 'insert file path/VPR/output/'
nucmaskdir <- 'insert file path/VPR/dapi/mask/'
arraymaskdir <- 'insert file path/VPR/array_mask/'
reporterdir <- 'insert file path/VPR/ms2_fish/'
halodir <- 'insert file path/VPR/laci_halo/'
gfpdir <- 'insert file path/VPR/rtetr_gfp/'


filelist <- list.files(reporterdir, pattern = ".tif")
#remove characters that is different between mask' and images' name
imagenames <- gsub(".tif","", filelist)
imagenames <- gsub("C2-","", imagenames)



lapply(imagenames, function(filename){
  
  #Load images
  nucmasks <- readImage(paste0(nucmaskdir, 'C4-', filename, '_cp_masks.png'))
  arraymasks_ori <- readImage(paste0(arraymaskdir, 'C1-', filename, '_Probabilities.tiff'))
  reporter <- readImage(paste0(reporterdir, 'C2-', filename, '.tif'))
  halo <- readImage(paste0(halodir, 'C1-', filename, '.tif'))
  gfp <- readImage(paste0(gfpdir, 'C3-', filename, '.tif'))
  
  #reformat nuclear masks
  nucmasks <-Image(as.numeric(as.factor(nucmasks))-1,dim = dim(nucmasks))
  
  #remove nuclei on edge of image
  dims<-dim(nucmasks)
  #get all nuclei ids that lies at the border of the nucmasks
  border<- c(nucmasks[1:dims[1],1], nucmasks[1:dims[1],dims[2]],nucmasks[1,1:dims[2]],nucmasks[dims[1],1:dims[2]])
  ids <- unique(border[which(border != 0)])
  #somehow rmObjects does not work on double anymore
  storage.mode(nucmasks) <- 'integer'
  nucmasks <- rmObjects((nucmasks), ids)
  storage.mode(nucmasks) <- 'double'
  
  #smooth arraymasks and binarize with threshold 
  arraymasks_blur <- gblur(arraymasks_ori, sigma=2)
  #how do we decide the amount of blur?
  arraythres <- 0.4
  #is it the probability value?
  bin_arraymasks <- arraymasks_blur > arraythres
  display(bin_arraymasks)
  #label all arrays in same cell to the same nucleus ID
  arraymasks <- bin_arraymasks * nucmasks
  
  #nucleoplasm masks - everything within nucleus but not identified as array
  nucplmasks <- (!bin_arraymasks) * nucmasks
  
  # make ring shape around array for calculating enrichment 
  #label the ring mask with nucleus ID
  dilate_binarraymasks <- dilate(bin_arraymasks, kern = makeBrush(5, shape = "disc"))
  ringmasks <- (dilate_binarraymasks - bin_arraymasks) * nucmasks

  #### Get morphological features of nucleus and array
  #nucleus
  #some images do not have any cells identified --> fill df with NA
  nucfeat <- cbind(computeFeatures.moment(nucmasks),computeFeatures.shape(nucmasks))
  if (is.null(nucfeat)){
    nucfeat_area <- data.frame("x" = NA, "y" = NA, "nucleus_area" = NA, "maskID" = NA)
  } else{
    nucfeat_area <- data.frame("x"=round(nucfeat[,"m.cx"]),"y"=round(nucfeat[,"m.cy"]),"nucleus_area"=nucfeat[,"s.area"])
    nucfeat_area$maskID <- rownames(nucfeat)
  }
  
  #array masks
  arrayfeat <- computeFeatures.shape(arraymasks)
  arrayfeat_area <- data.frame("array_size"= arrayfeat[,"s.area"])
  arrayfeat_area$maskID <- rownames(arrayfeat)
  #nucleoplasm masks
  npfeat <- computeFeatures.shape(nucplmasks)
  npfeat <- data.frame("nucleoplasms_area"= npfeat[,"s.area"])
  npfeat$maskID <- rownames(npfeat)
  print(arrayfeat)
  #some images do not have any array identified --> fill df with NA
  if (is.null(arrayfeat)){
    arrayfeat_area <- data.frame("maskID" = nucfeat_area$maskID)
    arrayfeat_area$array_size <- NA
  }
  
  feat <- nucfeat_area %>% full_join(arrayfeat_area, by="maskID") %>% full_join(npfeat, by="maskID")
  feat_colorder <- c("maskID", "x", "y", "nucleus_area", "array_size", "nucleoplasms_area")
  feat <- feat[, feat_colorder]
  
  ### Obtain MS2 signal intensity features at Nucleus (to ensure no signal is not due to untransfected + nodox samples quant)
  reporter_nuc_mean <- quantNuclei(nucmasks, reporter, mean)
  reporter_nuc_median <- quantNuclei(nucmasks, reporter, median)
  reporter_nuc_sd <- quantNuclei(nucmasks, reporter, sd)
  reporter_nuc_max <- quantNuclei(nucmasks, reporter, max)
  reporter_nuc_intden <- quantNuclei(nucmasks, reporter, sum)
  #what is intden?
  reporter_nuc <- data.frame(reporter_nuc_mean, reporter_nuc_median, reporter_nuc_sd, reporter_nuc_max, reporter_nuc_intden)
  
  ### Obtain Halo and GFP signal intensity features at Nucleus (to ensure no signal is not due to untransfected) (esp for nodox samples)
  halo_nuc_mean <- quantNuclei(nucmasks, halo, mean)
  halo_nuc_median <- quantNuclei(nucmasks, halo, median)
  halo_nuc_intden <- quantNuclei(nucmasks, halo, sum)
  
  gfp_nuc_mean <- quantNuclei(nucmasks, gfp, mean)
  gfp_nuc_median <- quantNuclei(nucmasks, gfp, median)
  gfp_nuc_intden <- quantNuclei(nucmasks, gfp, sum)
  
  #why not sd and max for the gfp and halo?
  
  halo_gfp_nuc <- data.frame(halo_nuc_mean, halo_nuc_median, halo_nuc_intden, gfp_nuc_mean, gfp_nuc_median, gfp_nuc_intden)
  
  ### Obtain MS2 signal intensity features at Nucleoplasm (for background subtraction)
  reporter_np_mean <- quantNuclei(nucplmasks, reporter, mean)
  reporter_np_median <- quantNuclei(nucplmasks, reporter, median)
  reporter_np_sd <- quantNuclei(nucplmasks, reporter, sd)
  reporter_np_max <- quantNuclei(nucplmasks, reporter, max)
  reporter_np_intden <- quantNuclei(nucplmasks, reporter, sum)
  
  reporter_np <- data.frame(reporter_np_mean, reporter_np_median, reporter_np_sd, reporter_np_max, reporter_np_intden)
  reporter_np$maskID <- rownames(reporter_np)
  
  halo_np_mean <- quantNuclei(nucplmasks, halo, mean)
  halo_np_median <- quantNuclei(nucplmasks, halo, median)
  halo_np_intden <- quantNuclei(nucplmasks, halo, sum)
  
  gfp_np_mean <- quantNuclei(nucplmasks, gfp, mean)
  gfp_np_median <- quantNuclei(nucplmasks, gfp, median)
  gfp_np_intden <- quantNuclei(nucplmasks, gfp, sum)
  
  halo_gfp_np <- data.frame(halo_np_mean, halo_np_median, halo_np_intden, gfp_np_mean, gfp_np_median, gfp_np_intden)
  halo_gfp_np$maskID <- rownames(halo_gfp_np)
  
  ### Obtain Halo and GFP signal intensity features at ARRAY (to ensure no signal is not due to untransfected/norecruitment at array) 
  halo_array_mean <- quantNuclei(arraymasks, halo, mean)
  halo_array_median <- quantNuclei(arraymasks, halo, median)
  halo_array_intden <- quantNuclei(arraymasks, halo, sum)
  
  gfp_array_mean <- quantNuclei(arraymasks, gfp, mean)
  gfp_array_median <- quantNuclei(arraymasks, gfp, median)
  gfp_array_intden <- quantNuclei(arraymasks, gfp, sum)
  
  halo_gfp_array <- data.frame(halo_array_mean, halo_array_median, halo_array_intden, gfp_array_mean, gfp_array_median, gfp_array_intden)
  halo_gfp_array$maskID <- rownames(halo_gfp_array)


  ### Obtain MS2 signal intensity features at ARRAY
  reporter_array_mean <- quantNuclei(arraymasks, reporter, mean)
  reporter_array_median <- quantNuclei(arraymasks, reporter, median)
  reporter_array_sd <- quantNuclei(arraymasks, reporter, sd)
  reporter_array_max <- quantNuclei(arraymasks, reporter, max)
  reporter_array_intden <- quantNuclei(arraymasks, reporter, sum)
  
  reporter_array <- data.frame(reporter_array_mean, reporter_array_median, reporter_array_sd, reporter_array_max, reporter_array_intden)
  reporter_array$maskID <- rownames(reporter_array)
  
  ### Obtain MS2 signal intensity features at ARRAY RING (for enrichment analyses)
  reporter_ring_mean <- quantNuclei(ringmasks, reporter, mean)
  reporter_ring_median <- quantNuclei(ringmasks, reporter, median)
  reporter_ring_sd <- quantNuclei(ringmasks, reporter, sd)
  reporter_ring_max <- quantNuclei(ringmasks, reporter, max)
  reporter_ring_intden <- quantNuclei(ringmasks, reporter, sum)
  
  reporter_ring <- data.frame(reporter_ring_mean, reporter_ring_median, reporter_ring_sd, reporter_ring_max, reporter_ring_intden)
  reporter_ring$maskID <- rownames(reporter_ring)
  
  halo_ring_mean <- quantNuclei(ringmasks, halo, mean)
  halo_ring_median <- quantNuclei(ringmasks, halo, median)
  halo_ring_intden <- quantNuclei(ringmasks, halo, sum)
  
  gfp_ring_mean <- quantNuclei(ringmasks, gfp, mean)
  gfp_ring_median <- quantNuclei(ringmasks, gfp, median)
  gfp_ring_intden <- quantNuclei(ringmasks, gfp, sum)
  
  halo_gfp_ring <- data.frame(halo_ring_mean, halo_ring_median, halo_ring_intden, gfp_ring_mean, gfp_ring_median, gfp_ring_intden)
  halo_gfp_ring$maskID <- rownames(halo_gfp_ring)
  
  #summary
  quantsum <- data.frame('Image'= filename, feat, reporter_nuc, halo_gfp_nuc) %>% full_join(reporter_np, by="maskID") %>% full_join(halo_gfp_np, by="maskID") %>% full_join(reporter_array, by="maskID") %>% full_join(halo_gfp_array, by="maskID") %>% full_join(reporter_ring, by="maskID") %>% full_join(halo_gfp_ring, by="maskID")

  #quantsum <- data.frame('Image'= filename, feat, reporter_nuc, halo_gfp_nuc) %>% full_join(halo_gfp_array, by="maskID") %>% full_join(reporter_array, by="maskID") 

  write.table(quantsum, paste0(datadir, filename, '.csv'), sep="\t", row.names = F)

})
    



```


Combine all quantitative data (.csv) together in one dataframe

```{r}
library(dplyr)
library(stringr)

datadir <- 'insert file path/VPR/output/'

#read csv files
filelist <- list.files(datadir, pattern='.csv')

#combine all quantsum csv files 
datalist <- lapply(filelist, function(filename){
  df <- read.table(paste0(datadir, filename), sep="\t", header=TRUE)
})
all <- bind_rows(datalist)

all <- all %>% mutate(dox = case_when(
                str_detect(Image, '_\\+Dox_') ~ 'yes',
                str_detect(Image, '_-Dox_') ~ 'no'
)) 
all$dox <- as.factor(all$dox)

### change this according to your Effectors
all <- all %>% mutate(effector = dplyr::case_when(
                str_detect(Image, '-NLS_') ~ 'Ctrl',
                str_detect(Image, '-HP1a_') ~ 'mHP1alpha',
                str_detect(Image, '-KRAB_') ~ 'KRAB'
))
all$effector <- factor(all$effector, levels=c('Ctrl', 'mHP1alpha', 'KRAB'))



```

Filtering and Plots


```{r}
library(ggplot2)
library(tidyr)
library(EnvStats)
library(scatterplot3d)

##### Filtering #####
outdir <- 'insert file path/VPR/data/'


# create timestamp for this run
timestamp <- format(Sys.time(),"%Y%m%d%H%M%S")

# create outout folder
dir.create(paste0(outdir,timestamp,"_data"))

## Remove too small/big arraylei
plot(all$nucleus_area)

# threshold decided based on plotting nucleus area
nuc_up <- 35000
nuc_down <- 5000

all_filt <- all %>% filter(between(nucleus_area, nuc_down, nuc_up))

## Include only datapoints that have signals in all 3 channels to only include cells with all 3 plasmids transfected
plot(all_filt$halo_nuc_mean)
plot(all_filt$gfp_nuc_mean)
# threshold based on untransfected images background mean value
halo_nuc_thres <- 0.001678749
gfp_nuc_thres <- 0.001366015

all_filt <- all_filt %>% filter(halo_nuc_mean > halo_nuc_thres) %>% filter(gfp_nuc_mean > gfp_nuc_thres)

all_filt$halo_enriched_mean <- log2((all_filt$halo_array_mean)/(all_filt$halo_ring_mean))

all_filt$gfp_enriched_mean <- log2((all_filt$gfp_array_mean)/(all_filt$gfp_ring_mean))

all_filt$halobygfp_mean <- log2((all_filt$halo_array_mean/all_filt$halo_ring_mean)/(all_filt$gfp_array_mean/all_filt$gfp_ring_mean))

all_filt <- all_filt %>%
  select(1:28, 54:56, 29:53)
 
silence_threshold_RNase_mean <-  0.0144359124661222

# include only datapoints that have both gfp and halo signal in array (= both activator and effector are recruited to array)
plot(all_filt$halo_array_mean)
plot(all_filt$gfp_array_mean)
#threshold is arbitrary, based on looking at data+images
halo_array_thres <- 0.01
gfp_array_thres <- 0.01

all_array <- all_filt %>% filter(halo_array_mean > halo_array_thres) %>% filter(gfp_array_mean > gfp_array_thres)

#for dox
dox_only_array <- all_array$dox == "yes"
Ctrl_only_array <- all_array$effector == "Ctrl"
mHP1alpha_only_array <- all_array$effector == "mHP1alpha"
KRAB_only_array <- all_array$effector == "KRAB"

Ctrl_combi_con_array <- dox_only_array & Ctrl_only_array
mHP1alpha_combi_con_array <- dox_only_array & mHP1alpha_only_array
KRAB_combi_con_array <- dox_only_array & KRAB_only_array

all_array_Ctrl_dox <- subset(all_array, Ctrl_combi_con_array) 
all_array_mHP1alpha_dox <- subset(all_array, mHP1alpha_combi_con_array)
all_array_KRAB_dox <- subset(all_array, KRAB_combi_con_array)

active_Ctrl <- all_array_Ctrl_dox[all_array_Ctrl_dox$reporter_array_mean > silence_threshold_RNase_mean,]
active_mHP1alpha <- all_array_mHP1alpha_dox[all_array_mHP1alpha_dox$reporter_array_mean > silence_threshold_RNase_mean,]
active_KRAB <- all_array_KRAB_dox[all_array_KRAB_dox$reporter_array_mean > silence_threshold_RNase_mean,]

silent_Ctrl <- all_array_Ctrl_dox[all_array_Ctrl_dox$reporter_array_mean < silence_threshold_RNase_mean,]
silent_mHP1alpha <- all_array_mHP1alpha_dox[all_array_mHP1alpha_dox$reporter_array_mean < silence_threshold_RNase_mean,]
silent_KRAB <- all_array_KRAB_dox[all_array_KRAB_dox$reporter_array_mean < silence_threshold_RNase_mean,]

# Calculate the percentage of data points below silencing threshold
percentage_active_Ctrl <- (nrow(active_Ctrl) / nrow(all_array_Ctrl_dox)) * 100
percentage_active_mHP1alpha <- (nrow(active_mHP1alpha) / nrow(all_array_mHP1alpha_dox)) * 100
percentage_active_KRAB <- (nrow(active_KRAB) / nrow(all_array_KRAB_dox)) * 100

percentage_silent_Ctrl <- (nrow(silent_Ctrl) / nrow(all_array_Ctrl_dox)) * 100
percentage_silent_mHP1alpha <- (nrow(silent_mHP1alpha) / nrow(all_array_mHP1alpha_dox)) * 100
percentage_silent_KRAB <- (nrow(silent_KRAB) / nrow(all_array_KRAB_dox)) * 100

combined_active <- bind_rows(active_Ctrl, active_mHP1alpha, active_KRAB)
combined_silent <- bind_rows(silent_Ctrl, silent_mHP1alpha, silent_KRAB)

#for no dox
nodox_only <- all_filt$dox == "no"
Ctrl_only_filt <- all_filt$effector == "Ctrl"
mHP1alpha_only_filt <- all_filt$effector == "mHP1alpha"
KRAB_only_filt <- all_filt$effector == "KRAB"

Ctrl_combi_con_filt <- nodox_only & Ctrl_only_filt
mHP1alpha_combi_con_filt <- nodox_only & mHP1alpha_only_filt
KRAB_combi_con_filt <- nodox_only & KRAB_only_filt

all_filt_Ctrl_nodox <- subset(all_filt, Ctrl_combi_con_filt) 
all_filt_mHP1alpha_nodox <- subset(all_filt, mHP1alpha_combi_con_filt)
all_filt_KRAB_nodox <- subset(all_filt, KRAB_combi_con_filt)

combined_no_dox <- bind_rows(all_filt_Ctrl_nodox, all_filt_mHP1alpha_nodox, all_filt_KRAB_nodox)

combined_percent_VPR <- data_frame(percentage_active_Ctrl, percentage_active_mHP1alpha, percentage_active_KRAB, percentage_silent_Ctrl, percentage_silent_mHP1alpha, percentage_silent_KRAB)

write.csv(combined_no_dox, file = paste0(outdir, timestamp, "_data", "/reporter_signal_nodox_VPR.csv"), row.names = FALSE)
write.csv(combined_percent_VPR, file = paste0(outdir, timestamp, "_data", "/combined_percent_active-silent_VPR.csv"), row.names = FALSE)
write.csv(combined_active, file = paste0(outdir, timestamp, "_data", "/reporter_signal_VPR.csv"), row.names = FALSE)

```

```{r}
library(dplyr)
library(stringr)

datadir <- 'insert file path/VPR/output/output_02/'

#read csv files
filelist <- list.files(datadir, pattern='.csv')

#combine all quantsum csv files 
datalist <- lapply(filelist, function(filename){
  df <- read.table(paste0(datadir, filename), sep="\t", header=TRUE)
})
all <- bind_rows(datalist)

all <- all %>% mutate(dox = case_when(
                str_detect(Image, '_\\+Dox_') ~ 'yes',
                str_detect(Image, '_-Dox_') ~ 'no'
)) 
all$dox <- as.factor(all$dox)

### change this according to your Effectors
all <- all %>% mutate(effector = dplyr::case_when(
                str_detect(Image, '-NLS_') ~ 'Ctrl',
                str_detect(Image, '-HP1a_') ~ 'mHP1alpha',
                str_detect(Image, '-KRAB_') ~ 'KRAB'
))
all$effector <- factor(all$effector, levels=c('Ctrl', 'mHP1alpha', 'KRAB'))



```


```{r}
library(ggplot2)
library(tidyr)
library(EnvStats)
library(scatterplot3d)

##### Filtering #####
outdir <- 'insert file path/VPR/data/'


# create timestamp for this run
timestamp <- format(Sys.time(),"%Y%m%d%H%M%S")

# create outout folder
dir.create(paste0(outdir,timestamp,"_data"))

## Remove too small/big arraylei
plot(all$nucleus_area)

# threshold decided based on plotting nucleus area
nuc_up <- 35000
nuc_down <- 5000

all_filt <- all %>% filter(between(nucleus_area, nuc_down, nuc_up))

## Include only datapoints that have signals in all 3 channels to only include cells with all 3 plasmids transfected
plot(all_filt$halo_nuc_mean)
plot(all_filt$gfp_nuc_mean)
# threshold based on untransfected images background mean value
halo_nuc_thres <- 0.001678749
gfp_nuc_thres <- 0.001366015

all_filt <- all_filt %>% filter(halo_nuc_mean > halo_nuc_thres) %>% filter(gfp_nuc_mean > gfp_nuc_thres)

all_filt$halo_enriched_mean <- log2((all_filt$halo_array_mean)/(all_filt$halo_ring_mean))

all_filt$gfp_enriched_mean <- log2((all_filt$gfp_array_mean)/(all_filt$gfp_ring_mean))

all_filt$halobygfp_mean <- log2((all_filt$halo_array_mean/all_filt$halo_ring_mean)/(all_filt$gfp_array_mean/all_filt$gfp_ring_mean))

all_filt <- all_filt %>%
  select(1:28, 54:56, 29:53)

silence_threshold_RNase_mean <-  0.0144359124661222

# include only datapoints that have both gfp and halo signal in array (= both activator and effector are recruited to array)
plot(all_filt$halo_array_mean)
plot(all_filt$gfp_array_mean)
#threshold is arbitrary, based on looking at data+images
halo_array_thres <- 0.01
gfp_array_thres <- 0.01

all_array <- all_filt %>% filter(halo_array_mean > halo_array_thres) %>% filter(gfp_array_mean > gfp_array_thres)

#for dox
dox_only_array <- all_array$dox == "yes"
Ctrl_only_array <- all_array$effector == "Ctrl"
mHP1alpha_only_array <- all_array$effector == "mHP1alpha"
KRAB_only_array <- all_array$effector == "KRAB"

Ctrl_combi_con_array <- dox_only_array & Ctrl_only_array
mHP1alpha_combi_con_array <- dox_only_array & mHP1alpha_only_array
KRAB_combi_con_array <- dox_only_array & KRAB_only_array

all_array_Ctrl_dox <- subset(all_array, Ctrl_combi_con_array) 
all_array_mHP1alpha_dox <- subset(all_array, mHP1alpha_combi_con_array)
all_array_KRAB_dox <- subset(all_array, KRAB_combi_con_array)

active_Ctrl <- all_array_Ctrl_dox[all_array_Ctrl_dox$reporter_array_mean > silence_threshold_RNase_mean,]
active_mHP1alpha <- all_array_mHP1alpha_dox[all_array_mHP1alpha_dox$reporter_array_mean > silence_threshold_RNase_mean,]
active_KRAB <- all_array_KRAB_dox[all_array_KRAB_dox$reporter_array_mean > silence_threshold_RNase_mean,]

silent_Ctrl <- all_array_Ctrl_dox[all_array_Ctrl_dox$reporter_array_mean < silence_threshold_RNase_mean,]
silent_mHP1alpha <- all_array_mHP1alpha_dox[all_array_mHP1alpha_dox$reporter_array_mean < silence_threshold_RNase_mean,]
silent_KRAB <- all_array_KRAB_dox[all_array_KRAB_dox$reporter_array_mean < silence_threshold_RNase_mean,]

# Calculate the percentage of data points below silencing threshold
percentage_active_Ctrl <- (nrow(active_Ctrl) / nrow(all_array_Ctrl_dox)) * 100
percentage_active_mHP1alpha <- (nrow(active_mHP1alpha) / nrow(all_array_mHP1alpha_dox)) * 100
percentage_active_KRAB <- (nrow(active_KRAB) / nrow(all_array_KRAB_dox)) * 100

percentage_silent_Ctrl <- (nrow(silent_Ctrl) / nrow(all_array_Ctrl_dox)) * 100
percentage_silent_mHP1alpha <- (nrow(silent_mHP1alpha) / nrow(all_array_mHP1alpha_dox)) * 100
percentage_silent_KRAB <- (nrow(silent_KRAB) / nrow(all_array_KRAB_dox)) * 100

combined_active <- bind_rows(active_Ctrl, active_mHP1alpha, active_KRAB)
combined_silent <- bind_rows(silent_Ctrl, silent_mHP1alpha, silent_KRAB)

#for no dox
nodox_only <- all_filt$dox == "no"
Ctrl_only_filt <- all_filt$effector == "Ctrl"
mHP1alpha_only_filt <- all_filt$effector == "mHP1alpha"
KRAB_only_filt <- all_filt$effector == "KRAB"

Ctrl_combi_con_filt <- nodox_only & Ctrl_only_filt
mHP1alpha_combi_con_filt <- nodox_only & mHP1alpha_only_filt
KRAB_combi_con_filt <- nodox_only & KRAB_only_filt

all_filt_Ctrl_nodox <- subset(all_filt, Ctrl_combi_con_filt) 
all_filt_mHP1alpha_nodox <- subset(all_filt, mHP1alpha_combi_con_filt)
all_filt_KRAB_nodox <- subset(all_filt, KRAB_combi_con_filt)

combined_no_dox <- bind_rows(all_filt_Ctrl_nodox, all_filt_mHP1alpha_nodox, all_filt_KRAB_nodox)

combined_percent_VPR_02 <- data_frame(percentage_active_Ctrl, percentage_active_mHP1alpha, percentage_active_KRAB, percentage_silent_Ctrl, percentage_silent_mHP1alpha, percentage_silent_KRAB)

write.csv(combined_no_dox, file = paste0(outdir, timestamp, "_data", "/reporter_signal_nodox_VPR_02.csv"), row.names = FALSE)
write.csv(combined_percent_VPR_02, file = paste0(outdir, timestamp, "_data", "/combined_percent_active-silent_VPR_02.csv"), row.names = FALSE)
write.csv(combined_active, file = paste0(outdir, timestamp, "_data", "/reporter_signal_VPR_02.csv"), row.names = FALSE)

```

